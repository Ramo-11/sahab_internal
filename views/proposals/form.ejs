<%- include('../partials/header') %>
<link rel="stylesheet" href="/public/css/proposal.css">

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><%= proposal ? 'Edit Proposal' : 'Create New Proposal' %></h2>
        <p class="text-muted"><%= proposal ? 'Update proposal details' : 'Create a new proposal for your client' %></p>
    </div>
    <a href="/proposals" class="btn btn-secondary">Back to Proposals</a>
</div>

<div class="card">
    <div class="card-body">
        <form action="<%= action %>" method="POST" id="proposalForm">
            <% if (method === 'PUT') { %>
                <input type="hidden" name="_method" value="PUT">
            <% } %>
            
            <!-- Client Selection -->
            <div class="form-section">
                <h4>Client Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="client_id" class="form-label">Client *</label>
                        <select class="form-control" id="client_id" name="client_id" required>
                            <option value="">Select a client</option>
                            <% if (clients && clients.length > 0) { %>
                                <% clients.forEach(client => { %>
                                    <option value="<%= client.id %>" <%= proposal && proposal.client_id == client.id ? 'selected' : '' %>>
                                        <%= client.name %><% if (client.company) { %> - <%= client.company %><% } %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                        <% if (!clients || clients.length === 0) { %>
                            <small class="text-muted">No clients available. <a href="/clients/new">Add a client first</a>.</small>
                        <% } %>
                    </div>
                    
                    <div class="form-group">
                        <label for="title" class="form-label">Proposal Title *</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="title" 
                            name="title" 
                            value="<%= proposal ? proposal.title : '' %>" 
                            required
                            placeholder="Enter proposal title"
                        >
                    </div>
                </div>
            </div>

            <!-- Project Details -->
            <div class="form-section">
                <h4>Project Details</h4>
                
                <div class="form-group">
                    <label for="description" class="form-label">Project Description *</label>
                    <textarea 
                        class="form-control" 
                        id="description" 
                        name="description" 
                        rows="5"
                        required
                        placeholder="Describe the project scope, objectives, and what you'll deliver..."
                    ><%= proposal ? (proposal.description || '') : '' %></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="proposed_timeline" class="form-label">Timeline *</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="proposed_timeline" 
                            name="proposed_timeline" 
                            value="<%= proposal ? (proposal.proposed_timeline || '') : '' %>"
                            required
                            placeholder="e.g., 4-6 weeks, 2 months, etc."
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="amount" class="form-label">Total Cost ($) *</label>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="amount" 
                            name="amount" 
                            value="<%= proposal ? (proposal.amount || '') : '' %>"
                            step="0.01"
                            min="0"
                            required
                            placeholder="0.00"
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start_date" class="form-label">Project Start Date</label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="start_date" 
                            name="start_date" 
                            value="<%= proposal ? (proposal.start_date ? new Date(proposal.start_date).toISOString().split('T')[0] : '') : '' %>"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="due_date" class="form-label">Project Due Date</label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="due_date" 
                            name="due_date" 
                            value="<%= proposal ? (proposal.due_date ? new Date(proposal.due_date).toISOString().split('T')[0] : '') : '' %>"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="valid_until" class="form-label">Proposal Valid Until</label>
                    <input 
                        type="date" 
                        class="form-control" 
                        id="valid_until" 
                        name="valid_until" 
                        value="<%= proposal ? (proposal.valid_until ? new Date(proposal.valid_until).toISOString().split('T')[0] : '') : '' %>"
                    >
                </div>
            </div>

            <!-- Project Features Section -->
            <div class="form-section">
                <h4>Project Features</h4>
                <div class="feature-selector">
                    <p class="text-muted mb-3">Click on suggested features to add them, or type custom features below:</p>
                    
                    <!-- Suggested Features -->
                    <div class="suggested-features">
                        <span class="suggested-feature" onclick="addFeature('Landing Page')">Landing Page</span>
                        <span class="suggested-feature" onclick="addFeature('Contact Form')">Contact Form</span>
                        <span class="suggested-feature" onclick="addFeature('User Authentication')">User Authentication</span>
                        <span class="suggested-feature" onclick="addFeature('Google Authentication')">Google Authentication</span>
                        <span class="suggested-feature" onclick="addFeature('Database Integration')">Database Integration</span>
                        <span class="suggested-feature" onclick="addFeature('Payment Processing')">Payment Processing</span>
                        <span class="suggested-feature" onclick="addFeature('Admin Dashboard')">Admin Dashboard</span>
                        <span class="suggested-feature" onclick="addFeature('Email Notifications')">Email Notifications</span>
                        <span class="suggested-feature" onclick="addFeature('Search Functionality')">Search Functionality</span>
                        <span class="suggested-feature" onclick="addFeature('Mobile Responsive')">Mobile Responsive</span>
                        <span class="suggested-feature" onclick="addFeature('SEO Optimization')">SEO Optimization</span>
                        <span class="suggested-feature" onclick="addFeature('Content Management')">Content Management</span>
                        <span class="suggested-feature" onclick="addFeature('E-commerce')">E-commerce</span>
                        <span class="suggested-feature" onclick="addFeature('API Integration')">API Integration</span>
                        <span class="suggested-feature" onclick="addFeature('Analytics')">Analytics</span>
                        <span class="suggested-feature" onclick="addFeature('Social Media Integration')">Social Media Integration</span>
                        <span class="suggested-feature" onclick="addFeature('File Upload')">File Upload</span>
                        <span class="suggested-feature" onclick="addFeature('Live Chat')">Live Chat</span>
                        <span class="suggested-feature" onclick="addFeature('Newsletter')">Newsletter</span>
                        <span class="suggested-feature" onclick="addFeature('Blog')">Blog</span>
                    </div>
                    
                    <!-- Custom Feature Input -->
                    <div class="d-flex gap-2 mb-3">
                        <input 
                            type="text" 
                            id="customFeature" 
                            class="form-control" 
                            placeholder="Type a custom feature..."
                            onkeypress="if(event.key==='Enter'){event.preventDefault();addCustomFeature();}"
                        >
                        <button type="button" class="btn btn-secondary" onclick="addCustomFeature()">Add</button>
                    </div>
                    
                    <!-- Selected Features Display -->
                    <div class="selected-features" id="selectedFeatures">
                        <!-- Selected features will appear here -->
                    </div>
                    
                    <!-- Hidden input to store features -->
                    <input type="hidden" id="project_features" name="project_features" value="" 
                        data-existing-features="<%= proposal ? (proposal.project_features || '') : '' %>">
                </div>
            </div>

            <!-- Technical Highlights Section -->
            <div class="form-section">
                <h4>Technical Highlights</h4>
                <div class="form-group">
                    <label for="technical_highlights" class="form-label">Technical Specifications</label>
                    <textarea 
                        class="form-control" 
                        id="technical_highlights" 
                        name="technical_highlights" 
                        rows="4"
                        placeholder="List key technologies, frameworks, integrations, or technical specifications..."
                    ><%= proposal ? (proposal.technical_highlights || '') : '' %></textarea>
                    <small class="text-muted">Optional: Highlight technical aspects that differentiate your solution</small>
                </div>
            </div>
            
            <% if (proposal) { %>
                <div class="form-section">
                    <h4>Status</h4>
                    <div class="form-group">
                        <label for="status" class="form-label">Proposal Status</label>
                        <select class="form-control" id="status" name="status">
                            <option value="draft" <%= proposal.status === 'draft' ? 'selected' : '' %>>Draft</option>
                            <option value="sent" <%= proposal.status === 'sent' ? 'selected' : '' %>>Sent</option>
                            <option value="accepted" <%= proposal.status === 'accepted' ? 'selected' : '' %>>Accepted</option>
                            <option value="rejected" <%= proposal.status === 'rejected' ? 'selected' : '' %>>Rejected</option>
                            <option value="expired" <%= proposal.status === 'expired' ? 'selected' : '' %>>Expired</option>
                        </select>
                    </div>
                </div>
            <% } %>
            
            <div class="d-flex gap-3 mt-4">
                <button type="submit" class="btn btn-primary">
                    <%= proposal ? 'Update Proposal' : 'Create Proposal' %>
                </button>
                <a href="/proposals" class="btn btn-secondary">Cancel</a>
                <% if (proposal) { %>
                    <a href="/proposals/<%= proposal.id %>" class="btn btn-secondary">View Proposal</a>
                <% } %>
            </div>
        </form>
    </div>
</div>

<script src="/public/js/proposal-form.js"></script>

<%- include('../partials/footer') %>