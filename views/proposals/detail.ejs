<%- include('../partials/header') %>
<link rel="stylesheet" href="/public/css/proposal.css">

<!-- Hidden data attributes for JavaScript -->
<div style="display: none;" 
     data-proposal-id="<%= proposal.id %>"
     data-client-id="<%= proposal.client_id %>"
     data-proposal-title="<%= proposal.title %>"
     data-proposal-description="<%= proposal.description || '' %>"
     data-proposal-amount="<%= proposal.amount || 0 %>"
     data-proposal-valid-until="<%= proposal.valid_until || '' %>"
     data-technical-highlights="<%= proposal.technical_highlights || '' %>"
     data-proposed-timeline="<%= proposal.proposed_timeline || '' %>"
     data-start-date="<%= proposal.start_date || '' %>"
     data-due-date="<%= proposal.due_date || '' %>"
     data-project-features="<%= proposal.project_features || '' %>">
</div>

<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <div>
        <h2><%= proposal.title %></h2>
        <p class="text-muted">Proposal for <%= proposal.client_name %></p>
    </div>
    <div class="d-flex gap-2">
        <a href="/proposals" class="btn btn-secondary">Back to Proposals</a>
        <a href="/proposals/<%= proposal.id %>/edit" class="btn btn-primary">Edit Proposal</a>
        <% if (proposal.status === 'accepted') { %>
            <a href="/invoices/new?proposal_id=<%= proposal.id %>" class="btn btn-success">Create Invoice</a>
        <% } %>
        <button onclick="printProposal()" class="btn btn-secondary">Print</button>
    </div>
</div>

<!-- Proposal Status Alert -->
<% if (proposal.status === 'expired' || (proposal.valid_until && new Date(proposal.valid_until) < new Date() && proposal.status !== 'accepted' && proposal.status !== 'rejected')) { %>
    <div class="card mb-4 no-print" style="border-color: var(--danger-color); background: rgba(239, 68, 68, 0.05);">
        <div class="card-body">
            <h6 class="text-danger">⚠️ This proposal has expired</h6>
            <p class="text-muted mb-0">Consider creating a new proposal or extending the validity date.</p>
        </div>
    </div>
<% } %>

<div class="grid-3 mb-4 no-print">
    <!-- Proposal Status -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Status</h6>
            <span class="status-badge status-<%= proposal.status %> fs-6"><%= proposal.status.toUpperCase() %></span>
        </div>
    </div>
    
    <!-- Total Amount -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Total Cost</h6>
            <h4 class="text-success">$<%= (proposal.amount || 0).toFixed(2) %></h4>
        </div>
    </div>
    
    <!-- Timeline -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Timeline</h6>
            <% if (proposal.proposed_timeline) { %>
                <p class="mb-0"><%= proposal.proposed_timeline %></p>
            <% } else { %>
                <p class="text-muted mb-0">Not specified</p>
            <% } %>
        </div>
    </div>
</div>

<div class="proposal-document card">
    <div class="card-body">
        <!-- Header Section -->
        <div class="proposal-header">
            <div class="d-flex justify-content-between align-items-start mb-5">
                <div style="flex: 1;">
                    <h1 class="proposal-title">PROJECT PROPOSAL</h1>
                    <p class="proposal-subtitle"><%= proposal.title %></p>
                    <p class="proposal-number">Proposal #<%= proposal.id %></p>
                </div>
                <div class="proposal-date-info">
                    <p><strong>Date:</strong> <%= new Date(proposal.created_at).toLocaleDateString() %></p>
                    <% if (proposal.valid_until) { %>
                        <p><strong>Valid Until:</strong> <%= new Date(proposal.valid_until).toLocaleDateString() %></p>
                    <% } %>
                    <% if (proposal.start_date) { %>
                        <p><strong>Start Date:</strong> <%= new Date(proposal.start_date).toLocaleDateString() %></p>
                    <% } %>
                    <% if (proposal.due_date) { %>
                        <p><strong>Due Date:</strong> <%= new Date(proposal.due_date).toLocaleDateString() %></p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Client Information Section -->
        <div class="client-information-section mb-5">
            <h3 class="section-title">Client Information</h3>
            <div class="grid-2">
                <div class="company-section">
                    <h4>From:</h4>
                    <div class="company-info">
                        <strong><%= process.env.COMPANY_NAME || 'Your Company' %></strong><br>
                        <% if (process.env.COMPANY_ADDRESS) { %><%= process.env.COMPANY_ADDRESS %><br><% } %>
                        <% if (process.env.COMPANY_PHONE) { %><%= process.env.COMPANY_PHONE %><br><% } %>
                        <% if (process.env.COMPANY_EMAIL) { %><%= process.env.COMPANY_EMAIL %><br><% } %>
                        <% if (process.env.COMPANY_WEBSITE) { %><%= process.env.COMPANY_WEBSITE %><% } %>
                    </div>
                </div>
                
                <div class="client-section">
                    <h4>To:</h4>
                    <div class="client-info">
                        <strong>Business Name:</strong> <%= proposal.client_company || 'N/A' %><br>
                        <strong>Contact Person:</strong> <%= proposal.client_name %><br>
                        <% if (proposal.client_email) { %>
                            <strong>Email:</strong> <a href="mailto:<%= proposal.client_email %>"><%= proposal.client_email %></a><br>
                        <% } %>
                        <% if (proposal.client_phone) { %>
                            <strong>Phone:</strong> <a href="tel:<%= proposal.client_phone %>"><%= proposal.client_phone %></a><br>
                        <% } %>
                        <% if (proposal.client_address) { %>
                            <strong>Address:</strong> <%= proposal.client_address %><br>
                            <% if (proposal.client_city || proposal.client_state || proposal.client_zip_code) { %>
                                <%= proposal.client_city %><% if (proposal.client_city && proposal.client_state) { %>, <% } %><%= proposal.client_state %> <%= proposal.client_zip_code %>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Details Section -->
        <div class="project-details-section mb-5">
            <h3 class="section-title">Project Details</h3>
            
            <!-- Project Description -->
            <% if (proposal.description) { %>
                <div class="proposal-description">
                    <h4 style="margin-bottom: var(--spacing-md); color: var(--primary-color);">Description</h4>
                    <%- proposal.description.replace(/\n/g, '<br>') %>
                </div>
            <% } %>
            
            <!-- Project Timeline and Cost -->
            <div class="proposal-meta-grid">
                <% if (proposal.proposed_timeline) { %>
                <div class="meta-item">
                    <strong>Timeline:</strong> <%= proposal.proposed_timeline %>
                </div>
                <% } %>
                <div class="meta-item">
                    <strong>Total Cost:</strong> $<%= (proposal.amount || 0).toFixed(2) %>
                </div>
                <% if (proposal.start_date) { %>
                <div class="meta-item">
                    <strong>Start Date:</strong> <%= new Date(proposal.start_date).toLocaleDateString() %>
                </div>
                <% } %>
                <% if (proposal.due_date) { %>
                <div class="meta-item">
                    <strong>Due Date:</strong> <%= new Date(proposal.due_date).toLocaleDateString() %>
                </div>
                <% } %>
            </div>

            <!-- Project Features -->
            <% if (proposal.project_features) { %>
                <div class="proposal-features mt-4">
                    <h4 style="margin-bottom: var(--spacing-lg); color: var(--primary-color);">Features & Deliverables</h4>
                    <div class="features-grid">
                        <% 
                        try {
                            const features = JSON.parse(proposal.project_features);
                            features.forEach(feature => { %>
                                <div class="feature-item">
                                    <span class="feature-icon">✓</span>
                                    <span class="feature-text"><%= feature %></span>
                                </div>
                        <% });
                        } catch(e) {
                            // Fallback for simple string format
                            if (proposal.project_features.trim()) {
                                const features = proposal.project_features.split(',');
                                features.forEach(feature => { 
                                    if (feature.trim()) { %>
                                        <div class="feature-item">
                                            <span class="feature-icon">✓</span>
                                            <span class="feature-text"><%= feature.trim() %></span>
                                        </div>
                                <% }
                                });
                            }
                        } %>
                    </div>
                </div>
            <% } %>

            <!-- Technical Highlights -->
            <% if (proposal.technical_highlights && proposal.technical_highlights.trim()) { %>
                <div class="technical-highlights mt-4">
                    <h4 style="margin-bottom: var(--spacing-lg); color: var(--primary-color);">Technical Highlights</h4>
                    <div class="technical-content">
                        <%- proposal.technical_highlights.replace(/\n/g, '<br>') %>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Investment Summary -->
        <div class="investment-summary">
            <h3 class="section-title">Investment Summary</h3>
            <div class="investment-details">
                <div class="investment-item">
                    <span class="investment-label">Total Project Investment:</span>
                    <span class="investment-amount">$<%= (proposal.amount || 0).toFixed(2) %></span>
                </div>
                <% if (proposal.proposed_timeline) { %>
                <div class="investment-item">
                    <span class="investment-label">Estimated Timeline:</span>
                    <span class="investment-timeline"><%= proposal.proposed_timeline %></span>
                </div>
                <% } %>
                <% if (proposal.start_date && proposal.due_date) { %>
                <div class="investment-item">
                    <span class="investment-label">Project Duration:</span>
                    <span class="investment-timeline">
                        <%= new Date(proposal.start_date).toLocaleDateString() %> - <%= new Date(proposal.due_date).toLocaleDateString() %>
                    </span>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Next Steps Section -->
        <div class="proposal-terms">
            <h3 class="section-title">Next Steps</h3>
            <div class="terms-content">
                <p><strong>Proposal Review:</strong> Please review this proposal carefully and reach out with any questions or clarifications needed.</p>
                
                <p><strong>Acceptance Process:</strong></p>
                <ul>
                    <li>Upon acceptance of this proposal, we'll provide a detailed project contract</li>
                    <li>A project kickoff meeting will be scheduled to finalize requirements and timeline</li>
                    <li>Project development will commence upon contract signing and initial payment</li>
                    <li>Regular progress updates and milestone reviews will be scheduled throughout the project</li>
                </ul>
                
                <p><strong>Timeline:</strong> This proposal is valid until <%= proposal.valid_until ? new Date(proposal.valid_until).toLocaleDateString() : 'further notice' %>. We recommend moving forward promptly to secure your preferred project timeline.</p>
                
                <p><strong>Questions & Contact:</strong><br>
                Feel free to reach out with any questions, concerns, or requested modifications to this proposal. We're committed to ensuring this project meets your exact needs and expectations.</p>
                
                <% if (process.env.COMPANY_EMAIL || process.env.COMPANY_PHONE) { %>
                <p><strong>Contact Information:</strong><br>
                <% if (process.env.COMPANY_EMAIL) { %>Email: <%= process.env.COMPANY_EMAIL %><br><% } %>
                <% if (process.env.COMPANY_PHONE) { %>Phone: <%= process.env.COMPANY_PHONE %><% } %></p>
                <% } %>
            </div>
        </div>

        <!-- Signature Section -->
        <div class="signature-section">
            <h3 class="section-title">Agreement</h3>
            <p style="margin-bottom: var(--spacing-xl); color: var(--text-secondary);">
                By signing below, you accept the terms and scope outlined in this proposal.
            </p>
            <div class="grid-2">
                <div class="signature-block">
                    <div class="signature-line"></div>
                    <p class="signature-label">Client Signature</p>
                </div>
                <div class="signature-block">
                    <div class="signature-line"></div>
                    <p class="signature-label">Date</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mt-4 no-print">
    <div class="card-header">
        <h5>Quick Actions</h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-3 flex-wrap">
            <!-- Status Update Buttons -->
            <% if (proposal.status === 'draft') { %>
                <button onclick="updateStatus('sent')" class="btn btn-primary">Mark as Sent</button>
            <% } %>
            
            <% if (proposal.status === 'sent') { %>
                <button onclick="updateStatus('accepted')" class="btn btn-success">Mark as Accepted</button>
                <button onclick="updateStatus('rejected')" class="btn btn-danger">Mark as Rejected</button>
            <% } %>
            
            <% if (proposal.status === 'accepted') { %>
                <a href="/invoices/new?proposal_id=<%= proposal.id %>" class="btn btn-success">Create Invoice</a>
            <% } %>
            
            <% if (proposal.status === 'rejected') { %>
                <button onclick="updateStatus('draft')" class="btn btn-secondary">Mark as Draft</button>
                <button onclick="updateStatus('sent')" class="btn btn-primary">Mark as Sent</button>
            <% } %>
            
            <!-- Other Actions -->
            <a href="/proposals/<%= proposal.id %>/edit" class="btn btn-secondary">Edit Proposal</a>
            <button onclick="duplicateProposal()" class="btn btn-secondary">Duplicate</button>
        </div>
    </div>
</div>

<script src="/public/js/proposal-detail.js"></script>

<%- include('../partials/footer') %>