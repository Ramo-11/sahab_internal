<%- include('../partials/header') %>
<link rel="stylesheet" href="/public/css/proposal.css">

<!-- Hidden data attributes for JavaScript -->
<div style="display: none;" 
     data-proposal-id="<%= proposal.id %>"
     data-client-id="<%= proposal.client_id %>"
     data-proposal-title="<%= proposal.title %>"
     data-proposal-description="<%= proposal.description || '' %>"
     data-proposal-amount="<%= proposal.amount || 0 %>"
     data-proposal-valid-until="<%= proposal.valid_until || '' %>"
     data-technical-highlights="<%= proposal.technical_highlights || '' %>">
</div>

<div class="d-flex justify-content-between align-items-center mb-4 no-print">
    <div>
        <h2><%= proposal.title %></h2>
        <p class="text-muted">Proposal for <%= proposal.client_name %></p>
    </div>
    <div class="d-flex gap-2">
        <a href="/proposals" class="btn btn-secondary">Back to Proposals</a>
        <a href="/proposals/<%= proposal.id %>/edit" class="btn btn-primary">Edit Proposal</a>
        <% if (proposal.status === 'accepted') { %>
            <a href="/invoices/new?proposal_id=<%= proposal.id %>" class="btn btn-success">Create Invoice</a>
        <% } %>
        <button onclick="printProposal()" class="btn btn-secondary">Print</button>
    </div>
</div>

<!-- Proposal Status Alert -->
<% if (proposal.status === 'expired' || (proposal.valid_until && new Date(proposal.valid_until) < new Date() && proposal.status !== 'accepted' && proposal.status !== 'rejected')) { %>
    <div class="card mb-4 no-print" style="border-color: var(--danger-color); background: rgba(239, 68, 68, 0.05);">
        <div class="card-body">
            <h6 class="text-danger">⚠️ This proposal has expired</h6>
            <p class="text-muted mb-0">Consider creating a new proposal or extending the validity date.</p>
        </div>
    </div>
<% } %>

<div class="grid-3 mb-4 no-print">
    <!-- Proposal Status -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Status</h6>
            <span class="status-badge status-<%= proposal.status %> fs-6"><%= proposal.status.toUpperCase() %></span>
        </div>
    </div>
    
    <!-- Total Amount -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Total Amount</h6>
            <h4 class="text-success">$<%= (proposal.amount || 0).toFixed(2) %></h4>
        </div>
    </div>
    
    <!-- Valid Until -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Valid Until</h6>
            <% if (proposal.valid_until) { %>
                <p class="mb-0"><%= new Date(proposal.valid_until).toLocaleDateString() %></p>
            <% } else { %>
                <p class="text-muted mb-0">No expiry date</p>
            <% } %>
        </div>
    </div>
</div>

<div class="proposal-document card">
    <div class="card-body">
        <!-- Header Section -->
        <div class="proposal-header">
            <div class="d-flex justify-content-between align-items-start mb-5">
                <div>
                    <h1 class="proposal-title">PROJECT PROPOSAL</h1>
                    <p class="proposal-subtitle"><%= proposal.title %></p>
                    <p class="proposal-number">Proposal #<%= proposal.id %></p>
                </div>
                <div class="text-right">
                    <div class="proposal-date-info">
                        <p><strong>Date:</strong> <%= new Date(proposal.created_at).toLocaleDateString() %></p>
                        <% if (proposal.valid_until) { %>
                            <p><strong>Valid Until:</strong> <%= new Date(proposal.valid_until).toLocaleDateString() %></p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Company & Client Information -->
        <div class="grid-2 mb-5">
            <div class="company-section">
                <h4 class="section-title">From:</h4>
                <div class="company-info">
                    <strong><%= process.env.COMPANY_NAME || 'Your Company' %></strong><br>
                    <% if (process.env.COMPANY_ADDRESS) { %><%= process.env.COMPANY_ADDRESS %><br><% } %>
                    <% if (process.env.COMPANY_PHONE) { %><%= process.env.COMPANY_PHONE %><br><% } %>
                    <% if (process.env.COMPANY_EMAIL) { %><%= process.env.COMPANY_EMAIL %><br><% } %>
                    <% if (process.env.COMPANY_WEBSITE) { %><%= process.env.COMPANY_WEBSITE %><% } %>
                </div>
            </div>
            
            <div class="client-section">
                <h4 class="section-title">To:</h4>
                <div class="client-info">
                    <strong><%= proposal.client_name %></strong><br>
                    <% if (proposal.client_company) { %>
                        <%= proposal.client_company %><br>
                    <% } %>
                    <% if (proposal.client_email) { %>
                        <%= proposal.client_email %><br>
                    <% } %>
                    <% if (proposal.client_phone) { %>
                        <%= proposal.client_phone %><br>
                    <% } %>
                    <% if (proposal.client_address) { %>
                        <%= proposal.client_address %><br>
                        <% if (proposal.client_city || proposal.client_state || proposal.client_zip_code) { %>
                            <%= proposal.client_city %><% if (proposal.client_city && proposal.client_state) { %>, <% } %><%= proposal.client_state %> <%= proposal.client_zip_code %>
                        <% } %>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Project Overview -->
        <div class="proposal-content mb-5">
            <h3 class="section-title">Project Overview</h3>
            
            <% if (proposal.description) { %>
                <div class="proposal-description">
                    <%- proposal.description.replace(/\n/g, '<br>') %>
                </div>
            <% } %>
            
            <!-- Project Meta Information -->
            <div class="proposal-meta-grid">
                <% if (proposal.proposed_timeline) { %>
                <div class="meta-item">
                    <strong>Timeline:</strong> <%= proposal.proposed_timeline %>
                </div>
                <% } %>
                <div class="meta-item">
                    <strong>Investment:</strong> $<%= (proposal.amount || 0).toFixed(2) %>
                </div>
            </div>
        </div>

        <!-- Project Features -->
        <% if (proposal.project_features) { %>
            <div class="proposal-features mb-5">
                <h3 class="section-title">Features & Deliverables</h3>
                <div class="features-grid">
                    <% 
                    try {
                        const features = JSON.parse(proposal.project_features);
                        features.forEach(feature => { %>
                            <div class="feature-item">
                                <span class="feature-icon">✓</span>
                                <span class="feature-text"><%= feature %></span>
                            </div>
                    <% });
                    } catch(e) {
                        // Fallback for simple string format
                        const features = proposal.project_features.split(',');
                        features.forEach(feature => { 
                            if (feature.trim()) { %>
                                <div class="feature-item">
                                    <span class="feature-icon">✓</span>
                                    <span class="feature-text"><%= feature.trim() %></span>
                                </div>
                    <% }
                        });
                    } %>
                </div>
            </div>
        <% } %>

        <!-- Technical Highlights -->
        <% if (proposal.technical_highlights && proposal.technical_highlights.trim()) { %>
            <div class="technical-highlights mb-5">
                <h3 class="section-title">Technical Highlights</h3>
                <div class="technical-content">
                    <%- proposal.technical_highlights.replace(/\n/g, '<br>') %>
                </div>
            </div>
        <% } %>

        <!-- Investment Summary -->
        <div class="investment-summary mb-5">
            <h3 class="section-title">Investment Summary</h3>
            <div class="investment-details">
                <div class="investment-item">
                    <span class="investment-label">Total Project Investment:</span>
                    <span class="investment-amount">$<%= (proposal.amount || 0).toFixed(2) %></span>
                </div>
                <% if (proposal.proposed_timeline) { %>
                <div class="investment-item">
                    <span class="investment-label">Estimated Timeline:</span>
                    <span class="investment-timeline"><%= proposal.proposed_timeline %></span>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Terms & Next Steps -->
        <div class="proposal-terms">
            <h3 class="section-title">Terms & Next Steps</h3>
            <div class="terms-content">
                <p><strong>Proposal Validity:</strong> This proposal is valid until <%= proposal.valid_until ? new Date(proposal.valid_until).toLocaleDateString() : 'further notice' %>.</p>
                
                <p><strong>Next Steps:</strong></p>
                <ul>
                    <li>Review this proposal and reach out with any questions</li>
                    <li>Upon acceptance, we'll provide a detailed project contract</li>
                    <li>Project timeline will commence upon contract signing and initial payment</li>
                </ul>
                
                <p><strong>Contact Information:</strong><br>
                Feel free to reach out with any questions or to discuss this proposal further.</p>
            </div>
        </div>

        <!-- Signature Section -->
        <div class="signature-section mt-5">
            <div class="grid-2">
                <div class="signature-block">
                    <div class="signature-line"></div>
                    <p class="signature-label">Client Signature</p>
                </div>
                <div class="signature-block">
                    <div class="signature-line"></div>
                    <p class="signature-label">Date</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mt-4 no-print">
    <div class="card-header">
        <h5>Quick Actions</h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-3 flex-wrap">
            <!-- Status Update Buttons -->
            <% if (proposal.status === 'draft') { %>
                <button onclick="updateStatus('sent')" class="btn btn-primary">Mark as Sent</button>
            <% } %>
            
            <% if (proposal.status === 'sent') { %>
                <button onclick="updateStatus('accepted')" class="btn btn-success">Mark as Accepted</button>
                <button onclick="updateStatus('rejected')" class="btn btn-danger">Mark as Rejected</button>
            <% } %>
            
            <% if (proposal.status === 'accepted') { %>
                <a href="/invoices/new?proposal_id=<%= proposal.id %>" class="btn btn-success">Create Invoice</a>
            <% } %>
            
            <% if (proposal.status === 'rejected') { %>
                <button onclick="updateStatus('draft')" class="btn btn-secondary">Mark as Draft</button>
                <button onclick="updateStatus('sent')" class="btn btn-primary">Mark as Sent</button>
            <% } %>
            
            <!-- Other Actions -->
            <a href="/proposals/<%= proposal.id %>/edit" class="btn btn-secondary">Edit Proposal</a>
            <button onclick="duplicateProposal()" class="btn btn-secondary">Duplicate</button>
        </div>
    </div>
</div>

<script src="/public/js/proposal-detail.js"></script>

<%- include('../partials/footer') %>