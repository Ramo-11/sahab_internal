<%- include('../partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Invoice <%= invoice.invoice_number %></h2>
        <p class="text-muted">Invoice for <%= invoice.client_name %></p>
    </div>
    <div class="d-flex gap-2">
        <a href="/invoices" class="btn btn-secondary">Back to Invoices</a>
        <% if (invoice.status === 'pending') { %>
            <button onclick="markPaid()" class="btn btn-success">Mark as Paid</button>
        <% } %>
        <a href="/invoices/<%= invoice.id %>/edit" class="btn btn-primary">Edit Invoice</a>
        <button onclick="printInvoice()" class="btn btn-secondary">Print</button>
    </div>
</div>

<!-- Invoice Status Alert -->
<% 
    const dueDate = new Date(invoice.due_date);
    const today = new Date();
    const isOverdue = invoice.status === 'pending' && invoice.due_date && dueDate < today;
    const daysOverdue = isOverdue ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;
%>

<% if (isOverdue) { %>
    <div class="card mb-4" style="border-color: var(--danger-color); background: rgba(239, 68, 68, 0.05);">
        <div class="card-body">
            <h6 class="text-danger">⚠️ This invoice is <%= daysOverdue %> days overdue</h6>
            <p class="text-muted mb-0">Follow up with the client to ensure timely payment.</p>
        </div>
    </div>
<% } %>

<div class="grid-3 mb-4">
    <!-- Invoice Status -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Status</h6>
            <span class="status-badge status-<%= invoice.status %> fs-6"><%= invoice.status.toUpperCase() %></span>
            <% if (invoice.paid_date) { %>
                <p class="text-muted mt-2 mb-0">Paid: <%= new Date(invoice.paid_date).toLocaleDateString() %></p>
            <% } %>
        </div>
    </div>
    
    <!-- Total Amount -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Total Amount</h6>
            <h4 class="<%= invoice.status === 'paid' ? 'text-success' : 'text-primary' %>">
                $<%= (invoice.total_amount || 0).toFixed(2) %>
            </h4>
            <% if (invoice.tax_amount && invoice.tax_amount > 0) { %>
                <small class="text-muted">Includes $<%= invoice.tax_amount.toFixed(2) %> tax</small>
            <% } %>
        </div>
    </div>
    
    <!-- Due Date -->
    <div class="card">
        <div class="card-body text-center">
            <h6>Due Date</h6>
            <% if (invoice.due_date) { %>
                <p class="mb-0 <%= isOverdue ? 'text-danger' : '' %>">
                    <%= new Date(invoice.due_date).toLocaleDateString() %>
                </p>
                <% if (isOverdue) { %>
                    <small class="text-danger"><%= daysOverdue %> days overdue</small>
                <% } %>
            <% } else { %>
                <p class="text-muted mb-0">No due date set</p>
            <% } %>
        </div>
    </div>
</div>

<div class="invoice-document card">
    <div class="card-body">
        <!-- Header Section -->
        <div class="invoice-header">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="invoice-title">INVOICE</h1>
                    <p class="invoice-number">Invoice #<%= invoice.invoice_number %></p>
                </div>
                <div class="text-right">
                    <p><strong>Issue Date:</strong> <%= new Date(invoice.issue_date || invoice.created_at).toLocaleDateString() %></p>
                    <% if (invoice.due_date) { %>
                        <p><strong>Due Date:</strong> <%= new Date(invoice.due_date).toLocaleDateString() %></p>
                    <% } %>
                    <% if (invoice.paid_date) { %>
                        <p><strong>Paid Date:</strong> <%= new Date(invoice.paid_date).toLocaleDateString() %></p>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Company and Client Information -->
        <div class="grid-2 mb-4">
            <div>
                <h4>From:</h4>
                <div class="company-info">
                    <strong><%= process.env.COMPANY_NAME || 'Your Company' %></strong><br>
                    <!-- Add your company details here -->
                </div>
            </div>
            
            <div>
                <h4>Bill To:</h4>
                <div class="client-info">
                    <strong><%= invoice.client_name %></strong><br>
                    <% if (invoice.client_company) { %>
                        <%= invoice.client_company %><br>
                    <% } %>
                    <% if (invoice.client_email) { %>
                        <%= invoice.client_email %><br>
                    <% } %>
                    <% if (invoice.client_phone) { %>
                        <%= invoice.client_phone %><br>
                    <% } %>
                    <% if (invoice.client_address) { %>
                        <%= invoice.client_address %><br>
                        <% if (invoice.client_city || invoice.client_state || invoice.client_zip_code) { %>
                            <%= invoice.client_city %><% if (invoice.client_city && invoice.client_state) { %>, <% } %><%= invoice.client_state %> <%= invoice.client_zip_code %>
                        <% } %>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Invoice Content -->
        <div class="invoice-content mb-4">
            <h4><%= invoice.title %></h4>
            <% if (invoice.description) { %>
                <div class="invoice-description">
                    <%= invoice.description.replace(/\n/g, '<br>') %>
                </div>
            <% } %>
            
            <% if (invoice.proposal_title) { %>
                <p class="text-muted">
                    <strong>Related Proposal:</strong> 
                    <a href="/proposals/<%= invoice.proposal_id %>" class="text-primary">
                        <%= invoice.proposal_title %>
                    </a>
                </p>
            <% } %>
        </div>

        <!-- Line Items -->
        <% if (items && items.length > 0) { %>
            <div class="invoice-items mb-4">
                <h4>Items & Services</h4>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% let subtotal = 0; %>
                            <% items.forEach(item => { %>
                                <% subtotal += item.amount || 0; %>
                                <tr>
                                    <td><%= item.description %></td>
                                    <td class="text-center"><%= item.quantity || 1 %></td>
                                    <td class="text-right">$<%= (item.rate || 0).toFixed(2) %></td>
                                    <td class="text-right">$<%= (item.amount || 0).toFixed(2) %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-right">Subtotal:</th>
                                <th class="text-right">$<%= (invoice.amount || subtotal).toFixed(2) %></th>
                            </tr>
                            <% if (invoice.tax_amount && invoice.tax_amount > 0) { %>
                                <tr>
                                    <th colspan="3" class="text-right">Tax:</th>
                                    <th class="text-right">$<%= invoice.tax_amount.toFixed(2) %></th>
                                </tr>
                            <% } %>
                            <tr>
                                <th colspan="3" class="text-right">Total:</th>
                                <th class="text-right text-success">$<%= (invoice.total_amount || 0).toFixed(2) %></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        <% } else { %>
            <!-- Simple invoice without line items -->
            <div class="invoice-totals mb-4">
                <div class="table-responsive">
                    <table class="table">
                        <tbody>
                            <tr>
                                <th class="text-right">Subtotal:</th>
                                <td class="text-right">$<%= (invoice.amount || 0).toFixed(2) %></td>
                            </tr>
                            <% if (invoice.tax_amount && invoice.tax_amount > 0) { %>
                                <tr>
                                    <th class="text-right">Tax:</th>
                                    <td class="text-right">$<%= invoice.tax_amount.toFixed(2) %></td>
                                </tr>
                            <% } %>
                            <tr>
                                <th class="text-right">Total:</th>
                                <th class="text-right text-success">$<%= (invoice.total_amount || 0).toFixed(2) %></th>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } %>

        <!-- Payment Terms -->
        <div class="invoice-terms">
            <h4>Payment Terms</h4>
            <p class="text-muted">
                <% if (invoice.due_date) { %>
                    Payment is due by <%= new Date(invoice.due_date).toLocaleDateString() %>.
                <% } else { %>
                    Payment is due upon receipt.
                <% } %>
                Please remit payment within the specified timeframe to avoid any late fees.
                Thank you for your business!
            </p>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mt-4">
    <div class="card-header">
        <h5>Quick Actions</h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-3 flex-wrap">
            <% if (invoice.status === 'pending') { %>
                <button onclick="markPaid()" class="btn btn-success">Mark as Paid</button>
                <button onclick="updateStatus('overdue')" class="btn btn-warning">Mark as Overdue</button>
            <% } %>
            
            <% if (invoice.status === 'overdue') { %>
                <button onclick="markPaid()" class="btn btn-success">Mark as Paid</button>
                <button onclick="updateStatus('pending')" class="btn btn-secondary">Mark as Pending</button>
            <% } %>
            
            <% if (invoice.status === 'paid') { %>
                <button onclick="updateStatus('pending')" class="btn btn-secondary">Mark as Unpaid</button>
            <% } %>
            
            <a href="/invoices/<%= invoice.id %>/edit" class="btn btn-primary">Edit Invoice</a>
            <button onclick="duplicateInvoice()" class="btn btn-secondary">Duplicate</button>
            <button onclick="sendReminder()" class="btn btn-secondary">Send Reminder</button>
        </div>
    </div>
</div>

<style>
.invoice-document {
    background: white;
    box-shadow: var(--shadow-lg);
}

.invoice-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--primary-color);
    margin-bottom: var(--spacing-sm);
}

.invoice-number {
    color: var(--text-muted);
    font-size: var(--font-size-sm);
}

.company-info,
.client-info {
    line-height: 1.6;
    color: var(--text-secondary);
}

.invoice-description {
    background: var(--bg-secondary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--primary-color);
    margin-top: var(--spacing-md);
    line-height: 1.7;
}

.invoice-terms {
    background: var(--bg-tertiary);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
    margin-top: var(--spacing-xl);
}

.invoice-totals {
    max-width: 400px;
    margin-left: auto;
}

@media print {
    .no-print,
    .card-header,
    .btn,
    .quick-actions {
        display: none !important;
    }
    
    .invoice-document {
        box-shadow: none;
        border: none;
    }
}
</style>

<script>
function markPaid() {
    if (confirm('Mark this invoice as paid?')) {
        fetch(`/invoices/<%= invoice.id %>/mark-paid`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                throw new Error('Failed to mark as paid');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking invoice as paid. Please try again.');
        });
    }
}

function updateStatus(newStatus) {
    if (confirm(`Are you sure you want to mark this invoice as ${newStatus}?`)) {
        fetch(`/invoices/<%= invoice.id %>`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_id: '<%= invoice.client_id %>',
                proposal_id: '<%= invoice.proposal_id || "" %>',
                title: '<%= invoice.title %>',
                description: '<%= invoice.description || "" %>',
                amount: '<%= invoice.amount || 0 %>',
                tax_amount: '<%= invoice.tax_amount || 0 %>',
                status: newStatus,
                due_date: '<%= invoice.due_date || "" %>'
            })
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating status. Please try again.');
        });
    }
}

function duplicateInvoice() {
    if (confirm('Create a copy of this invoice?')) {
        const params = new URLSearchParams({
            client_id: '<%= invoice.client_id %>',
            title: 'Copy of <%= invoice.title %>',
            description: '<%= invoice.description || "" %>',
            amount: '<%= invoice.amount || 0 %>',
            tax_amount: '<%= invoice.tax_amount || 0 %>'
        });
        
        window.location.href = `/invoices/new?${params.toString()}`;
    }
}

function sendReminder() {
    alert('Reminder functionality would be implemented here (email integration, etc.)');
}

function printInvoice() {
    window.print();
}
</script>

<%- include('../partials/footer') %>