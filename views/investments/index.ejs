<%
// Helper function to safely format numbers - prevents NaN
const formatCurrency = (value) => {
    const num = Number(value);
    if (isNaN(num) || !isFinite(num)) return '$0.00';
    if (Math.abs(num) >= 1000) {
        return '$' + (num / 1000).toFixed(1) + 'k';
    }
    return '$' + num.toFixed(2);
};

const formatNumber = (value, decimals = 0) => {
    const num = Number(value);
    if (isNaN(num) || !isFinite(num)) return '0';
    return num.toFixed(decimals);
};

const formatPercent = (value) => {
    const num = Number(value);
    if (isNaN(num) || !isFinite(num)) return '0%';
    const sign = num > 0 ? '+' : '';
    return sign + num.toFixed(1) + '%';
};

// Type colors and icons
const typeStyles = {
    stocks: { bg: 'rgba(59, 130, 246, 0.1)', color: '#3b82f6', icon: 'fa-chart-line' },
    bonds: { bg: 'rgba(139, 92, 246, 0.1)', color: '#8b5cf6', icon: 'fa-file-contract' },
    real_estate: { bg: 'rgba(16, 185, 129, 0.1)', color: '#10b981', icon: 'fa-building' },
    crypto: { bg: 'rgba(245, 158, 11, 0.1)', color: '#f59e0b', icon: 'fa-bitcoin-sign' },
    mutual_fund: { bg: 'rgba(236, 72, 153, 0.1)', color: '#ec4899', icon: 'fa-layer-group' },
    business: { bg: 'rgba(99, 102, 241, 0.1)', color: '#6366f1', icon: 'fa-briefcase' },
    other: { bg: 'rgba(107, 114, 128, 0.1)', color: '#6b7280', icon: 'fa-piggy-bank' }
};

const getTypeStyle = (type) => typeStyles[type] || typeStyles.other;
%>

<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Investments</h1>
        <p class="page-subtitle">Track your investments and returns</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-outline" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-primary" onclick="openNewInvestmentModal()">
            <i class="fas fa-plus"></i> New Investment
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="investment-stats-grid">
    <div class="investment-stat-card primary">
        <div class="stat-card-header">
            <div class="stat-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-trend <%= (stats.overallROI || 0) >= 0 ? 'up' : 'down' %>">
                <i class="fas fa-arrow-<%= (stats.overallROI || 0) >= 0 ? 'up' : 'down' %>"></i>
                <%= formatPercent(stats.overallROI || 0) %> ROI
            </div>
        </div>
        <div class="stat-card-value"><%= formatCurrency(stats.activePrincipal || 0) %></div>
        <div class="stat-card-label">Active Principal</div>
        <div class="stat-card-sublabel"><%= formatNumber(stats.activeCount || 0) %> active investments</div>
    </div>

    <div class="investment-stat-card <%= (stats.totalAllTimeReturns || 0) >= 0 ? 'success' : '' %>">
        <div class="stat-card-header">
            <div class="stat-icon <%= (stats.totalAllTimeReturns || 0) >= 0 ? 'success' : 'danger' %>">
                <i class="fas fa-<%= (stats.totalAllTimeReturns || 0) >= 0 ? 'arrow-trend-up' : 'arrow-trend-down' %>"></i>
            </div>
        </div>
        <div class="stat-card-value"><%= formatCurrency(stats.totalAllTimeReturns || 0) %></div>
        <div class="stat-card-label">Total Returns</div>
        <div class="stat-card-sublabel">All time</div>
    </div>

    <div class="investment-stat-card">
        <div class="stat-card-header">
            <div class="stat-icon <%= (stats.currentMonthTotal || 0) >= 0 ? 'success' : 'danger' %>">
                <i class="fas fa-calendar-check"></i>
            </div>
            <% if (stats.lastMonthTotal !== 0) { %>
            <div class="stat-trend <%= (stats.monthlyChange || 0) >= 0 ? 'up' : 'down' %>">
                <i class="fas fa-arrow-<%= (stats.monthlyChange || 0) >= 0 ? 'up' : 'down' %>"></i>
                <%= formatPercent(stats.monthlyChange || 0) %>
            </div>
            <% } %>
        </div>
        <div class="stat-card-value"><%= formatCurrency(stats.currentMonthTotal || 0) %></div>
        <div class="stat-card-label">This Month</div>
        <div class="stat-card-sublabel">
            <span class="text-success">+<%= formatCurrency(stats.currentMonthGains || 0) %></span> / 
            <span class="text-danger"><%= formatCurrency(stats.currentMonthLosses || 0) %></span>
        </div>
    </div>

    <div class="investment-stat-card">
        <div class="stat-card-header">
            <div class="stat-icon info">
                <i class="fas fa-chart-pie"></i>
            </div>
        </div>
        <div class="stat-card-value"><%= formatCurrency(stats.totalPrincipal || 0) %></div>
        <div class="stat-card-label">Total Invested</div>
        <div class="stat-card-sublabel"><%= formatNumber(stats.totalCount || 0) %> total investments</div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-row">
    <!-- Monthly Returns Trend Chart -->
    <div class="chart-card">
        <div class="chart-card-header">
            <h3 class="chart-card-title">
                <i class="fas fa-chart-bar"></i> Monthly Returns
            </h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Investment Type Distribution Chart -->
    <div class="chart-card">
        <div class="chart-card-header">
            <h3 class="chart-card-title">
                <i class="fas fa-chart-pie"></i> By Type
            </h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="typeChart"></canvas>
        </div>
    </div>
</div>

<!-- Type Pills -->
<% if (stats.typeData && stats.typeData.length > 0) { %>
<div class="type-pills-container">
    <h3 class="section-title">
        <i class="fas fa-tags"></i> Performance by Type
    </h3>
    <div class="type-pills">
        <% stats.typeData.forEach(type => { 
            const style = getTypeStyle(type.type);
            const roi = parseFloat(type.roi) || 0;
        %>
        <div class="type-pill" style="background: '<%= style.bg %>'; border-color: '<%= style.color %>;'">
            <div class="type-pill-icon" style="background: '<%= style.color %>;'">
                <i class="fas <%= style.icon %>"></i>
            </div>
            <div class="type-pill-info">
                <span class="type-pill-name"><%= (type.type || 'other').replace('_', ' ') %></span>
                <span class="type-pill-amount"><%= formatCurrency(type.totalReturns) %></span>
            </div>
            <div class="type-pill-roi" style="color: '<%= roi >= 0 ? '#10b981' : '#ef4444' %>;'">
                <%= roi >= 0 ? '+' : '' %><%= type.roi %>%
            </div>
        </div>
        <% }); %>
    </div>
</div>
<% } %>

<!-- Filters -->
<div class="filters-card">
    <div class="filters-header">
        <h3 class="filters-title">
            <i class="fas fa-filter"></i> Filters
        </h3>
        <% if (filters.search || filters.type || filters.status) { %>
        <span class="filters-active">Filters Active</span>
        <% } %>
    </div>
    <div class="filters-row">
        <div class="filter-group">
            <label class="filter-label">Search</label>
            <input type="text" 
                   class="form-control" 
                   id="searchInput" 
                   placeholder="Search investments..."
                   value="<%= filters.search || '' %>">
        </div>
        <div class="filter-group">
            <label class="filter-label">Type</label>
            <select class="form-control" id="typeFilter">
                <option value="">All Types</option>
                <option value="stocks" <%= filters.type === 'stocks' ? 'selected' : '' %>>Stocks</option>
                <option value="bonds" <%= filters.type === 'bonds' ? 'selected' : '' %>>Bonds</option>
                <option value="real_estate" <%= filters.type === 'real_estate' ? 'selected' : '' %>>Real Estate</option>
                <option value="crypto" <%= filters.type === 'crypto' ? 'selected' : '' %>>Crypto</option>
                <option value="mutual_fund" <%= filters.type === 'mutual_fund' ? 'selected' : '' %>>Mutual Fund</option>
                <option value="business" <%= filters.type === 'business' ? 'selected' : '' %>>Business</option>
                <option value="other" <%= filters.type === 'other' ? 'selected' : '' %>>Other</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Status</label>
            <select class="form-control" id="statusFilter">
                <option value="">All Status</option>
                <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active</option>
                <option value="paused" <%= filters.status === 'paused' ? 'selected' : '' %>>Paused</option>
                <option value="closed" <%= filters.status === 'closed' ? 'selected' : '' %>>Closed</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-search"></i> Apply
            </button>
            <button class="btn btn-outline" onclick="clearFilters()">
                <i class="fas fa-times"></i> Clear
            </button>
        </div>
    </div>
</div>

<!-- Investments Grid -->
<h3 class="section-title">
    <i class="fas fa-piggy-bank"></i> Your Investments
    <span class="badge badge-secondary ml-2"><%= investments.length %></span>
</h3>

<% if (investments.length === 0) { %>
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-piggy-bank"></i>
        </div>
        <h4>No investments found</h4>
        <p>Add your first investment to start tracking returns</p>
        <button class="btn btn-primary mt-3" onclick="openNewInvestmentModal()">
            <i class="fas fa-plus"></i> Add Investment
        </button>
    </div>
</div>
<% } else { %>
<div class="investments-grid">
    <% investments.forEach(investment => { 
        const style = getTypeStyle(investment.type);
        const roi = parseFloat(investment.roi) || 0;
        const totalReturns = investment.totalReturns || 0;
    %>
    <div class="investment-card">
        <div class="investment-card-header">
            <div>
                <h4 class="investment-card-title"><%= investment.name %></h4>
                <span class="investment-card-type">
                    <i class="fas <%= style.icon %>" style="color: '<%= style.color %>;'"></i>
                    <%= (investment.type || 'other').replace('_', ' ') %>
                </span>
            </div>
            <span class="investment-card-status <%= investment.status %>"><%= investment.status %></span>
        </div>
        
        <div class="investment-card-body">
            <div class="investment-card-stats">
                <div class="investment-card-stat">
                    <span class="investment-card-stat-label">Principal</span>
                    <span class="investment-card-stat-value"><%= formatCurrency(investment.principal) %></span>
                </div>
                <div class="investment-card-stat">
                    <span class="investment-card-stat-label">Total Returns</span>
                    <span class="investment-card-stat-value <%= totalReturns >= 0 ? 'positive' : 'negative' %>">
                        <%= totalReturns >= 0 ? '+' : '' %><%= formatCurrency(totalReturns) %>
                    </span>
                </div>
            </div>
            
            <div class="investment-card-roi">
                <span class="investment-card-roi-label">Return on Investment</span>
                <span class="investment-card-roi-value <%= roi >= 0 ? 'positive' : 'negative' %>">
                    <%= roi >= 0 ? '+' : '' %><%= investment.roi %>%
                </span>
            </div>

            <!-- Returns toggle -->
            <% if (investment.returns && investment.returns.length > 0) { %>
            <button class="toggle-returns-btn" data-toggle-returns="<%= investment._id %>" onclick="toggleReturns('<%= investment._id %>')">
                <i class="fas fa-chevron-down"></i>
                <span><%= investment.returnCount %> return<%= investment.returnCount > 1 ? 's' : '' %> recorded</span>
            </button>
            
            <div class="returns-collapse" id="returns-<%= investment._id %>">
                <div class="returns-table-card">
                    <table class="table returns-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Notes</th>
                                <th width="60">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% investment.returns.slice(0, 5).forEach(ret => { %>
                            <tr>
                                <td><%= new Date(ret.returnDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></td>
                                <td class="return-amount <%= ret.amount > 0 ? 'positive' : ret.amount < 0 ? 'negative' : 'zero' %>">
                                    <%= ret.amount >= 0 ? '+' : '' %><%= formatCurrency(ret.amount) %>
                                </td>
                                <td><%= ret.notes || '-' %></td>
                                <td>
                                    <button class="btn btn-sm btn-icon btn-danger-icon" 
                                            onclick="deleteReturn('<%= investment._id %>', '<%= ret._id %>')" 
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <% }); %>
                            <% if (investment.returns.length > 5) { %>
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <small>+ <%= investment.returns.length - 5 %> more returns</small>
                                </td>
                            </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
            <% } else { %>
            <p class="text-muted text-center mb-0" style="font-size: 12px;">No returns recorded yet</p>
            <% } %>
        </div>
        
        <div class="investment-card-footer">
            <span class="investment-card-date">
                <i class="fas fa-calendar"></i>
                Started <%= new Date(investment.startDate).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) %>
            </span>
            <div class="investment-card-actions">
                <button class="btn btn-sm btn-icon btn-success-icon" 
                        onclick="openAddReturnModal('<%= investment._id %>', '<%= investment.name %>')" 
                        title="Add Return">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-sm btn-icon" 
                        onclick="viewInvestmentDetails('<%= investment._id %>')" 
                        title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-icon" 
                        onclick="editInvestment('<%= investment._id %>')" 
                        title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-icon btn-danger-icon" 
                        onclick="deleteInvestment('<%= investment._id %>')" 
                        title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
    <% }); %>
</div>
<% } %>

<!-- Hidden data for charts -->
<div id="investmentData" 
     style="display: none;"
     data-stats='<%- JSON.stringify(stats) %>'>
</div>

<%- include('modals') %>
